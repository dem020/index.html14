<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ú–æ—è –∫–∞—Ä—Ç–∞ - –í–∫—É—Å –°–°–°–†</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#d32f2f">

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #d32f2f;
      margin-bottom: 20px;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #e57373;
      color: white;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background-color: #c62828;
    }
    .info {
      background: #fafafa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    ul {
      list-style: none;
      padding-left: 0;
    }
    li {
      padding: 5px 0;
    }
    .transfer-form {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üë§ –ú–æ—è –∫–∞—Ä—Ç–∞ "–í–∫—É—Å –°–°–°–†"</h1>

    <!-- –í–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
    <input type="text" id="phoneInput" placeholder="+7 (___) ___-__-__" />
    <button onclick="checkCard()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—Ä—Ç—É</button>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
    <div class="info" id="cardInfo" style="display: none;">
      <p><strong>–ò–º—è:</strong> <span id="customerName"></span></p>
      <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="customerPhone"></span></p>
      <p><strong>–ë–∞–ª–ª—ã:</strong> <span id="customerPoints">0</span></p>
      <p><strong>–ú–∞–≥–∞–∑–∏–Ω:</strong> –í–∫—É—Å –°–°–°–†</p>

      <!-- –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤ -->
      <h3>–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</h3>
      <ul id="pointsHistory"></ul>

      <!-- –ü–µ—Ä–µ–≤–æ–¥ –±–∞–ª–ª–æ–≤ -->
      <div class="transfer-form">
        <h3>üí∏ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –±–∞–ª–ª—ã</h3>
        <input type="text" id="targetPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è" />
        <input type="number" id="pointsToTransfer" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤" min="1" />
        <button onclick="transferPoints()">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
      </div>
    </div>
  </div>

  <script>
    let customers = JSON.parse(localStorage.getItem("customers")) || {};

    function checkCard() {
      const phone = document.getElementById("phoneInput").value.trim();
      const infoDiv = document.getElementById("cardInfo");
      const nameEl = document.getElementById("customerName");
      const phoneEl = document.getElementById("customerPhone");
      const pointsEl = document.getElementById("customerPoints");
      const historyList = document.getElementById("pointsHistory");

      if (!phone) {
        alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞!");
        return;
      }

      if (customers[phone]) {
        const data = customers[phone];

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        nameEl.textContent = data.name || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
        phoneEl.textContent = phone;
        pointsEl.textContent = data.points;

        // –ò—Å—Ç–æ—Ä–∏—è
        historyList.innerHTML = "";
        if (data.history && data.history.length > 0) {
          data.history.forEach(entry => {
            const li = document.createElement("li");
            li.textContent = `${entry.text} (${entry.points})`;
            historyList.appendChild(li);
          });
        } else {
          historyList.innerHTML = "<li>–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</li>";
        }

        infoDiv.style.display = "block";

      } else {
        const confirmCreate = confirm("–ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é?");
        if (confirmCreate) {
          promptRegister(phone);
        }
      }
    }

    function promptRegister(phone) {
      const name = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:");
      if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");

      customers[phone] = { name, points: 0, history: [] };
      localStorage.setItem("customers", JSON.stringify(customers));
      alert("‚úÖ –ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!");

      checkCard(); // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω
    }

    function transferPoints() {
      const fromPhone = document.getElementById("phoneInput").value.trim();
      const toPhone = document.getElementById("targetPhone").value.trim();
      const pointsToTransfer = parseInt(document.getElementById("pointsToTransfer").value);

      if (!fromPhone || !toPhone || isNaN(pointsToTransfer) || pointsToTransfer <= 0) {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");
        return;
      }

      const sender = customers[fromPhone];
      const receiver = customers[toPhone];

      if (!sender) {
        alert("–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã");
        return;
      }

      if (!receiver) {
        alert("–ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
      }

      if (sender.points >= pointsToTransfer) {
        sender.points -= pointsToTransfer;
        receiver.points += pointsToTransfer;

        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
        sender.history.push({
          text: `–ü–µ—Ä–µ–≤–æ–¥ ${pointsToTransfer} –±–∞–ª–ª–æ–≤ –Ω–∞ ${toPhone}`,
          points: `- ${pointsToTransfer}`,
          date: new Date().toLocaleString()
        });

        receiver.history.push({
          text: `–ü–æ–ª—É—á–µ–Ω–æ ${pointsToTransfer} –±–∞–ª–ª–æ–≤ –æ—Ç ${fromPhone}`,
          points: `+ ${pointsToTransfer}`,
          date: new Date().toLocaleString()
        });

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        localStorage.setItem("customers", JSON.stringify(customers));

        // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω
        checkCard();

        alert(`‚úÖ –í—ã –ø–µ—Ä–µ–≤–µ–ª–∏ ${pointsToTransfer} –±–∞–ª–ª–æ–≤ –∫–ª–∏–µ–Ω—Ç—É ${toPhone}`);
      } else {
        alert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞");
      }
    }
  </script>
</body>
</html>
